<!doctype html> 
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" />
    <title>dev@cloudburo</title>
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><!--[if lt IE 9]><script src="../../js/ie8.js"></script><![endif]--><link href="../../css/all.css" rel="stylesheet" /><script type="text/javascript">
      (function(d,e,j,h,f,c,b){d.GoogleAnalyticsObject=f;d[f]=d[f]||function(){(d[f].q=d[f].q||[]).push(arguments)},d[f].l=1*new Date();c=e.createElement(j),b=e.getElementsByTagName(j)[0];c.async=1;c.src=h;b.parentNode.insertBefore(c,b)})(window,document,"script","//www.google-analytics.com/analytics.js","ga");ga("create","UA-35696879-1", location.hostname);ga("send","pageview");
    </script>
    <link href="/favicon.png" rel="icon" type="image/png" />
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro%3A400%2C400italic%2C700" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet" />
    <!--HTML5 shiv for IE8 support--><!--[if lt IE 9]
    | <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script-->
  </head>
  <body>
    <header class="header">
      <hgroup class="pull-left">
        <h1 class="site-title">
          <a href="/">dev@cloudburo</a>
        </h1>
      </hgroup>
      <div class="btn btn-primary pull-right" id="togglesidebar">
        <i class="fa fa-bars"></i>
      </div>
    </header>
    <div class="container">
      <div class="row">
        <div class="col-lg-12 col-md-12">
          <h2>
            Table of Content
          </h2>
          <ul>
          <li>
          <a href="#npm-node-modules">NPM Node Modules</a>
          <ul>
          <li>
          <a href="#clouburo-provided-modules">Clouburo provided Modules</a>
          </li>
          <li>
          <a href="#third-party-provided-modules">Third party provided Modules</a>
          </li>
          </ul>
          </li>
          <li>
          <a href="#file-directory-structure">File Directory Structure</a>
          <ul>
          <li>
          <a href="#index.js">index.js</a>
          </li>
          </ul>
          </li>
          <li>
          <a href="#model-loader">Model Loader</a>
          <ul>
          <li>
          <a href="#generic-loading-mechanism-for-backend-business-domain-model">Generic loading mechanism for backend business domain model</a>
          </li>
          <li>
          <a href="#generic-approach-to-bridge-frontend-backbone-business-domain-models">Generic approach to bridge frontend Backbone business domain models</a>
          </li>
          </ul>
          </li>
          </ul>
          <p>The Node.js based HTTP server is one of the runtime container used by the Cloudburo deployment strategy. <a href="http://http://nodejs.org/%22">Node.js</a> is a platform built on <a href="http://code.google.com/p/v8/">Chrome&rsquo;s</a> JavaScript runtime for easily building fast, scalable network applications. Node.js uses an event-driven, non-blocking I/O model that makes it lightweight and efficient, perfect for data-intensive real-time applications that run across distributed devices.</p>

<h2>NPM Node Modules</h2>

<p>Beside the node.js core server application a set of NPM packaged libraries are used, part of them are also used within the frontend based application (as for example &lsquo;underscore&rsquo; or &lsquo;coffee script&rsquo;)</p>

<h3>Clouburo provided Modules</h3>

<ul>
<li><a href="https://github.com/talfco/clb-modelloader">clb-modelloader</a>  is a small utility which is loading moongoose model definition files from a file directory location into a nodejs server instance and automatically creates corresponding request handlers</li>
</ul>

<h3>Third party provided Modules</h3>

<ul>
<li><a href="http://documentcloud.github.com/underscore/">underscore</a> is a utility-belt library for JavaScript that provides a lot of the functional programming support that you would expect in Prototype.js (or Ruby), but without extending any of the built-in JavaScript objects. It&rsquo;s the tie to go along with jQuery&rsquo;s tux, and Backbone.js&rsquo;s suspenders. Available on <a href="https://github.com/documentcloud/underscore/">github</a>.</li>
<li><a href="http://coffeescript.org/">coffee-script</a>: The CoffeeScript compiler is itself written in CoffeeScript, using the Jison parser generator. The command-line version of coffee is available as a Node.js utility. Available on <a href="https://github.com/jashkenas/coffee-script">github</a>.</li>
<li><a href="http://www.mongodb.org/">mongodb</a>: MongoDB (from &ldquo;humongous&rdquo;) is a scalable, high-performance, open source NoSQL database. Available on <a href="https://github.com/mongodb/mongo">github</a>.</li>
<li><a href="http://mongoosejs.com/">moongoose</a>: An elegant mongodb object modeling for node.js.</li>
<li><a href="http://expressjs.com/">express</a>: Express is a minimal and flexible node.js web application framework, providing a robust set of features for building single and multi-page, and hybrid web applications. Available on <a href="https://github.com/visionmedia/express">github</a>.</li>
<li><a href="https://github.com/sstephenson/stitch">stitch</a>: Develop and test your JavaScript applications as CommonJS modules in Node.js. Then Stitch them together to run in the browser. Available on <a href="https://github.com/sstephenson/stitch">github</a></li>
<li><a href="https://github.com/flatiron/winston#installation">winston</a>: A multi-transport async logging library for node.js. Available on <a href="https://github.com/flatiron/winston#installation">github</a>.</li>
<li><a href="https://github.com/mishoo/UglifyJS">uglify-js</a> JavaScript parser / mangler / compressor / beautifier library for NodeJS. Available on <a href="https://github.com/mishoo/UglifyJS">github</a></li>
</ul>

<h2>File Directory Structure</h2>

<p>The file directory consists of two parts</p>

<ul>
<li>backend-, server related files are stored in the following directory 

<ul>
<li> <code>root</code> directory itself contains of

<ul>
<li>the <code>index.js</code> file which will initialize the <code>Node.js</code> server application</li>
<li>the <code>cloudburoApp.js</code> file which bundles the CommonJS modules which makes up the application in a minified single javascript file. </li>
<li>the <code>modelLoader.coffee</code> file which loads the server side moongoose model of the application and injects the necessary event handlers.</li>
</ul></li>
<li><code>root/node_modules</code> contains all <code>Node.js</code> modules required by the server itsself, as for example <code>express, mongoose, mongodb, stitch, backbone, underscore</code> etc. These modules are managed via the <a href="https://npmjs.org/">Node Package Modules</a> mechanism.</li>
<li><code>server_models</code>directory contains all Mongoose based business concept object models of the Cloudburo App platform, as for example the models necessary to persists objects like <code>Customer</code>, <code>Service</code>, <code>Product</code>, <code>User</code>and so on.<br></li>
</ul></li>
<li>frontend-, browser related files are stored in <code>root/app</code> directory</li>
</ul>

<h3>index.js</h3>

<p>The <code>index.js</code> contains the code for the Node.js configuration it consists of the following main blocks</p>

<ol>
<li>Creating the Stitch package of the client side java script application, which will be transferred to the client during the initial web page opening</li>
<li>Setting up the <code>Node.js</code> Server and connecting to the cloud based MongoDB instance.</li>
<li>Loading all backend business domain model objects - which are based on mongoose - of the cloudburo app platform and bridge them to the corresponding Backbone frontend business domain model objects</li>
</ol>

<h2>Model Loader</h2>

<h3>Generic loading mechanism for backend business domain model</h3>

<p>The model loader will dynamically auto load the server models which are stored in the <code>server_models</code> directory.</p>

<pre><code class="coffeescript">modelLoader = new (require(&quot;./modelLoader&quot;))();
modelLoader.autoload(nodeserv,db, path.join(__dirname,&quot;server_models&quot;)); 
</code></pre>

<p>The server models are defining the mongoose schema for the business domain model objects they are responsible for. </p>

<pre><code class="coffeescript">module.exports = class ServiceTemplateModel extends BaseModel
    constructor: (props) -&gt;
        super  &#39;serviceTemplateModel&#39;,&#39;ServiceTemplateModel&#39;,
                new mongoose.Schema
                name:  { type: String, default: &#39;&#39; }
                type: { type: Number, default: &#39;&#39; }
                category:  { type: String}
                prize:  { type: String}
                duration:  { type: String}
    newInstance: (props) -&gt;
        return new ServiceTemplateModel props
</code></pre>

<p>Each server model extends the <code>BaseModel</code></p>

<pre><code class="coffeescript">module.exports = class BaseModel
    constructor: (@modelName,@dbModelName,@schema,props) -&gt;
        @dbModel = mongoose.model(@dbModelName, @schema)
        @model = new @dbModel(props)
        @schema.virtual(&#39;id&#39;).get -&gt; return this._id

        @schema.methods.toBackbone = -&gt;
                obj = this.toObject();
                obj.id = obj._id;
                return obj;

    getModelName: -&gt; @modelName
    getDBModel: -&gt;  @dbModel 
    getDBSchema: -&gt; @schema
    save: -&gt; @model.save()
</code></pre>

<p>The model loader will load each model module dynamically out of <code>server_models</code> directory, creates the relevant moongoose object and passes it over to the BackBoneBridge (see below the expose operation)</p>

<pre><code class="coffeescript">files = fs.readdirSync modelpath

modelNames = _und.map files, (f) =&gt; 
  path.basename f

bridge = new (require(&quot;./backboneBridge&quot;))()

_und.each modelNames, (modelName) -&gt;     
  modelC = require modelpath + &quot;/&quot; + modelName 
  util.inspect(modelC,true,true)
  if modelName != &quot;baseModel.coffee&quot;
     model = new modelC()        
     @expose(model,serv)
</code></pre>

<h3>Generic approach to bridge frontend Backbone business domain models</h3>

<p>The <code>expose</code> function will take care that backend requests triggered by  frontend Backbone based business object domain models are dispatched to the corresponding Mongoose based business object domain model which will handle the request in interaction with the database. 
For each server model a set of request handler will be created. In case the server model name is <code>customerModel.coffee</code> the URL path name will be the file name (without Model.coffee extension) plus an &rsquo;s&#39; for the plural, e.g <code>customers</code>. The following request handlers are created for each server model:</p>

<ol>
<li>get a list of a business domain objects (<code>/customers</code>), GET request</li>
<li>update a business domain object (<code>/customers/&lt;id&gt;</code>), PUT request</li>
<li>delete a business domain object (<code>/customers/&lt;id&gt;</code>), DELETE request</li>
<li>create a new business domain object (<code>/customers/&lt;id&gt;</code>), POST request</li>
</ol>

<p>The expose function looks like the following</p>

<pre><code class="coffeescript">    expose : (model, serv)-&gt;
        collection = model.getModelName()+&#39;s&#39;

        serv.get &#39;/&#39;+collection, (req, res) -&gt;
               model.getDBModel().find({}, (err, docs) -&gt; 
             if err != null
               res.json err, 500
            else
              res.send(docs))

       serv.put &#39;/&#39;+collection+&#39;/:id&#39;, (req, res) -&gt;
         conditions  = { _id: req.params.id }
         doc = req.body
         delete doc._id
         model.getDBModel().update conditions, doc,{}, (err, numAffected) -&gt; 
           if err == null 
             res.json  200
           else
             res.json err, 500

       serv.del &#39;/&#39;+collection+&#39;/:id&#39;, (req, res) -&gt;
         conditions  = { _id: req.params.id }
         model.getDBModel().remove conditions, (err, numAffected) -&gt; 
            if err == null 
             res.json  200
           else
             res.json err, 500    

       serv.post &#39;/&#39;+collection, (req, res) -&gt;
         conditions  = { _id: req.params.id }
         doc = req.body
         obj = model.newInstance doc 
         obj.save()  
         res.send  obj.model
</code></pre>
<footer class="footer">
            <p>
            </p>
            <div class="socials-footer"><a href="https://twitter.com/talfco" class="btn btn-twitter">
                  <i class="fa fa-twitter"></i></a><a href="https://www.facebook.com/Cloudburonet-897759390318816/" class="btn btn-facebook">
                  <i class="fa fa-facebook"></i></a><a href="https://plus.google.com/u/1/b/102868953630532463137/+CloudburoCh/posts" class="btn btn-google-plus">
                  <i class="fa fa-google-plus"></i></a><a href="https://www.linkedin.com/in/felixk" class="btn btn-linkedin">
                  <i class="fa fa-linkedin"></i></a><a href="https://github.com/talfco" class="btn btn-github">
                  <i class="fa fa-github"></i></a>
            </div>
            <p>
              Â© 2018 All rights reserved 
            </p>
          </footer>
        </div>
      </div>
    </div>
    <script src="../../js/all.js"></script>
  </body>
</html>