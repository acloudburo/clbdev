<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" />
    <title>dev@cloudburo | Meteor Small Hints #5: Server Code Fragments executed twice on Startup</title>
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><!--[if lt IE 9]><script src="../../../js/ie8.js" type="text/javascript"></script><![endif]--><link href="../../../css/all.css" media="screen" rel="stylesheet" type="text/css" /><script type="text/javascript">
      (function(d,e,j,h,f,c,b){d.GoogleAnalyticsObject=f;d[f]=d[f]||function(){(d[f].q=d[f].q||[]).push(arguments)},d[f].l=1*new Date();c=e.createElement(j),b=e.getElementsByTagName(j)[0];c.async=1;c.src=h;b.parentNode.insertBefore(c,b)})(window,document,"script","//www.google-analytics.com/analytics.js","ga");ga("create","UA-35696879-1", location.hostname);ga("send","pageview");
    </script>
    <link href="/favicon.png" rel="icon" type="image/png" />
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro%3A400%2C400italic%2C700" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet" />
    <!--HTML5 shiv for IE8 support--><!--[if lt IE 9]
    | <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script-->
  </head>
  <body>
    <div class="col-sm-3 sidebar" id="secondary" style="display: none;">
      <aside>
        <div class="about">
          <h4>
            <a class="sidebarlink" href="/"><i class="fa fa-chevron-right"></i>    Home     <i class="fa fa-home"></i></a>
          </h4>
          <h4>
            <a class="sidebarlink" href="/menu1.html"><i class="fa fa-chevron-right"></i>    About   </a>
          </h4>
          <h4>
            <a class="sidebarlink" href="/menu2.html"><i class="fa fa-chevron-right"></i>    Contact   </a>
          </h4>
        </div>
        <div class="tags">
          <h4>
            Categories
          </h4>
          <ul class="list-unstyled">
            <a class="label label-default" href="/tags/ai.html">ai (1)</a>
            <a class="label label-default" href="/tags/api.html">api (2)</a>
            <a class="label label-default" href="/tags/architecture.html">architecture (22)</a>
            <a class="label label-default" href="/tags/aws.html">aws (13)</a>
            <a class="label label-default" href="/tags/banking.html">banking (5)</a>
            <a class="label label-default" href="/tags/blockchain.html">blockchain (8)</a>
            <a class="label label-default" href="/tags/bots.html">bots (2)</a>
            <a class="label label-default" href="/tags/cloud.html">cloud (1)</a>
            <a class="label label-default" href="/tags/datascience.html">datascience (2)</a>
            <a class="label label-default" href="/tags/deutsch.html">deutsch (1)</a>
            <a class="label label-default" href="/tags/docker.html">docker (9)</a>
            <a class="label label-default" href="/tags/futurework.html">futureWork (5)</a>
            <a class="label label-default" href="/tags/gdpr.html">gdpr (1)</a>
            <a class="label label-default" href="/tags/googleapps.html">googleapps (1)</a>
            <a class="label label-default" href="/tags/gradle.html">gradle (2)</a>
            <a class="label label-default" href="/tags/identity.html">identity (1)</a>
            <a class="label label-default" href="/tags/inspiration.html">inspiration (6)</a>
            <a class="label label-default" href="/tags/javatutorial.html">javatutorial (3)</a>
            <a class="label label-default" href="/tags/legal.html">legal (1)</a>
            <a class="label label-default" href="/tags/meteor.html">meteor (5)</a>
            <a class="label label-default" href="/tags/microservice.html">microservice (15)</a>
            <a class="label label-default" href="/tags/ml.html">ml (1)</a>
            <a class="label label-default" href="/tags/modeling.html">modeling (1)</a>
            <a class="label label-default" href="/tags/personaldata.html">personalData (4)</a>
            <a class="label label-default" href="/tags/platform.html">platform (2)</a>
            <a class="label label-default" href="/tags/quicktips.html">quicktips (14)</a>
            <a class="label label-default" href="/tags/shift.html">shift (4)</a>
            <a class="label label-default" href="/tags/smallhints.html">smallhints (13)</a>
            <a class="label label-default" href="/tags/startup.html">startup (11)</a>
          </ul>
        </div>
        <div class="timeline">
          <h4>
            By year
          </h4>
          <ul class="list-unstyled">
            <a class="label label-primary" href="/2018.html">2018 (4)</a>
            <a class="label label-primary" href="/2017.html">2017 (18)</a>
            <a class="label label-primary" href="/2016.html">2016 (16)</a>
            <a class="label label-primary" href="/2015.html">2015 (35)</a>
            <a class="label label-primary" href="/2014.html">2014 (10)</a>
          </ul>
        </div>
      </aside>
    </div>
    <!--/#secondary-->
    <div class="col-sm-12" id="primary">
      <div class="content">
        <header class="header">
          <hgroup class="pull-left">
            <h1 class="site-title">
              <a href="/">dev@cloudburo</a>
            </h1>
          </hgroup>
          <div class="btn btn-primary pull-right" id="togglesidebar">
            <i class="fa fa-bars"></i>
          </div>
        </header>
        <section class="post">
          <header class="entry-header">
            <h2 class="entry-title">
              <a href="/2016/07/18/meteor-small-hints-5-server-code-fragments-executed-twice-on-startup.html">Meteor Small Hints #5: Server Code Fragments executed twice on Startup</a>
            </h2>
            <p class="entry-meta">
              Posted on  18.Jul 2016 | Tags <a class="label label-primary" href="/tags/smallhints.html">smallhints</a> <a class="label label-primary" href="/tags/meteor.html">meteor</a> 
            </p>
          </header>
          <div class="entry-description"><div class="row">
  <div class="article"><p><span/>      <div>
    Recently I got confused with my Meteor application, by having the server code executed twice at startup. So the code was initialising my application twice, as well as duplicated for example my Slack Sysadmin Bot running as part of the instance.
  </div>
  <div>
   <br>
  </div>
  <div>
    I was first thinking that it has something to do with my IntelliJ Webstorm IDE running in debug mode, but also the local test-, as well the my Modulus remote environment was showing the same symptom.
  </div>
  <div>
   <br>
  </div>
  <div>
    After some hours of debugging I luckily found the following
   <a href="https://github.com/Differential/meteor-workers/issues/9">Github issue entry</a> which showed me the right direction.
  </div>
  <div>
   <br>
  </div>
  <div>
    As part of my application I introduced
   <a href="https://github.com/Differential/meteor-workers">Differential meteor-workers</a>, which allows to spawn headless worker meteor processes to work on async jobs. For example, passing a message to my Slack SysAdmin Bot is done via Job.
  </div>
  <div>
   <br>
  </div>
  <div></p>
<pre class="highlight coffeescript"><code>
  <span class="k">class</span> <span class="vi">@</span><span class="na">SlackSysAdminBotJob</span> <span class="k">extends</span> <span class="nx">Job</span> 
    <span class="na">handleJob</span><span class="o">:</span> <span class="p">()</span><span class="o">-&gt;</span> 
      <span class="k">if</span> <span class="vi">@</span><span class="na">params</span><span class="p">.</span><span class="na">action</span> <span class="o">==</span> <span class="s">"sendMessage"</span> 
        <span class="vi">@</span><span class="na">params</span><span class="p">.</span><span class="na">bot</span><span class="p">.</span><span class="na">postTo</span> <span class="vi">@</span><span class="na">params</span><span class="p">.</span><span class="na">name</span><span class="p">,</span> <span class="vi">@</span><span class="na">params</span><span class="p">.</span><span class="na">text</span> 

</code></pre>

<div>
   <br>
  </div>

<p><div>
    Such a async Job can be easily triggered, like shown here (which will hand the work over to a worker process.
  </div>
  <div>
   <br>
  </div>
  <div></p>
<pre class="highlight coffeescript"><code>
    <span class="nx">Job</span><span class="p">.</span><span class="na">push</span> <span class="k">new</span> <span class="nx">SlackSysAdminBotJob</span> 
          <span class="na">action</span><span class="o">:</span> <span class="s">"sendMessage"</span> 
          <span class="na">slackBot</span><span class="o">:</span> <span class="nx">myBot</span> 
          <span class="na">text</span><span class="o">:</span><span class="nx">txt</span> 
          <span class="na">name</span><span class="o">:</span> <span class="nx">channel</span> 
        <span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">job</span><span class="p">)</span> <span class="o">-&gt;</span> 
           <span class="c1"># Check it 
</span>
</code></pre>

<div>
   <br>
  </div>

<p><div>
    Now introducing the Differential async worker resulted in the problem, that not only the master process, BUT also the worker process will be initialised with each Server startup code fragment. Which is not what we want.
  </div>
  <div>
   <br>
  </div>
  <div>
    So I had to extend each server Meter.startup code fragment by introducing an
   <i>isClusterMaster</i> check
  </div>
  <div>
   <br>
  </div>
  <div>
   <div></p>
<pre class="highlight coffeescript"><code>
  <span class="nx">exports</span><span class="p">.</span><span class="na">Plattform</span> <span class="o">=</span> 
      <span class="na">isClusterMaster</span><span class="o">:</span> <span class="p">()</span> <span class="o">-&gt;</span> 
        <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="na">isServer</span> <span class="o">&amp;&amp;</span> <span class="nx">Npm</span><span class="p">.</span><span class="na">require</span><span class="p">(</span><span class="s">'cluster'</span><span class="p">).</span><span class="na">isMaster</span> 


</code></pre>

<div>
   <br>
  </div>

<p><div>
    As for example:
  </div>
  <div>
   <br>
  </div>
  <div></p>
<pre class="highlight coffeescript"><code>
  <span class="nx">Meteor</span><span class="p">.</span><span class="na">startup</span> <span class="p">()</span> <span class="o">-&gt;</span> 
    <span class="k">if</span> <span class="nx">Plattform</span><span class="p">.</span><span class="na">isClusterMaster</span><span class="p">()</span> 
      <span class="c1"># The startup code 
</span>
</code></pre>

<p></div>
  <div>
   <br>
  </div>
  <div>
    Now the startup initialization will be only executed on the master in the cluster and not for each worker process.
  </div>
  <div>
   <br>
  </div></p>

  </div>
</div>
          </div>
          <div class="comments">
            <div id="disqus_thread">
              <div id="disqus_thread"></div>
              <script type="text/javascript">
              //<![CDATA[
                                var disqus_shortname = 'dev1cloudburo';
                        
                  (function() {
                      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                  })();
              //]]>
              </script>
              <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
              <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
              <script type="text/javascript">
              //<![CDATA[
                  var disqus_shortname = 'dev1cloudburo';
                  (function () {
                      var s = document.createElement('script'); s.async = true;
                      s.type = 'text/javascript';
                      s.src = '//' + disqus_shortname + '.disqus.com/count.js';
                      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
                  }());
              //]]>
              </script>
              
            </div>
          </div>
        </section><footer class="footer">
          <p>
          </p>
          <div class="socials-footer"><a class="btn btn-twitter" href="https://twitter.com/talfco">
                <i class="fa fa-twitter"></i></a><a class="btn btn-facebook" href="https://www.facebook.com/Cloudburonet-897759390318816/">
                <i class="fa fa-facebook"></i></a><a class="btn btn-google-plus" href="https://plus.google.com/u/1/b/102868953630532463137/+CloudburoCh/posts">
                <i class="fa fa-google-plus"></i></a><a class="btn btn-linkedin" href="https://www.linkedin.com/in/felixk">
                <i class="fa fa-linkedin"></i></a><a class="btn btn-github" href="https://github.com/talfco">
                <i class="fa fa-github"></i></a>
          </div>
          <p>
            © 2018 All rights reserved 
          </p>
        </footer>
      </div>
    </div>
    <script src="../../../js/all.js" type="text/javascript"></script>
  </body>
</html>