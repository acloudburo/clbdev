<!doctype html> 
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" />
    <title>dev@cloudburo | Meteor Small Hints #5: Server Code Fragments executed twice on Startup</title>
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" /><!--[if lt IE 9]><script src="../../../js/ie8.js" type="text/javascript"></script><![endif]--><link href="../../../css/all.css" media="screen" rel="stylesheet" type="text/css" /><script type="text/javascript">
      (function(d,e,j,h,f,c,b){d.GoogleAnalyticsObject=f;d[f]=d[f]||function(){(d[f].q=d[f].q||[]).push(arguments)},d[f].l=1*new Date();c=e.createElement(j),b=e.getElementsByTagName(j)[0];c.async=1;c.src=h;b.parentNode.insertBefore(c,b)})(window,document,"script","//www.google-analytics.com/analytics.js","ga");ga("create","UA-35696879-1", location.hostname);ga("send","pageview");
    </script>
    <link href="/favicon.png" rel="icon" type="image/png" />
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button class="navbar-toggle collapsed" data-target=".navbar-ex1-collapse" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="/">dev@cloudburo</a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
          <ul class="nav navbar-nav">
            <li>
              <a href="/menu1.html"> About  </a>
            </li>
            <li>
              <a href="/menu2.html"> Contact  </a>
            </li>
            <li class="dropdown">
              <a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">Categories <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li>
                  <a href="/tags/api.html">api (2)</a>
                </li>
                <li>
                  <a href="/tags/architecture.html">architecture (10)</a>
                </li>
                <li>
                  <a href="/tags/aws.html">aws (10)</a>
                </li>
                <li>
                  <a href="/tags/banking.html">banking (1)</a>
                </li>
                <li>
                  <a href="/tags/blockchain.html">blockchain (1)</a>
                </li>
                <li>
                  <a href="/tags/bootstrap.html">bootstrap (1)</a>
                </li>
                <li>
                  <a href="/tags/bots.html">bots (1)</a>
                </li>
                <li>
                  <a href="/tags/deutsch.html">deutsch (1)</a>
                </li>
                <li>
                  <a href="/tags/docker.html">docker (9)</a>
                </li>
                <li>
                  <a href="/tags/futurework.html">futureWork (5)</a>
                </li>
                <li>
                  <a href="/tags/googleapps.html">googleapps (1)</a>
                </li>
                <li>
                  <a href="/tags/gradle.html">gradle (2)</a>
                </li>
                <li>
                  <a href="/tags/inspiration.html">inspiration (2)</a>
                </li>
                <li>
                  <a href="/tags/legal.html">legal (1)</a>
                </li>
                <li>
                  <a href="/tags/meteor.html">meteor (5)</a>
                </li>
                <li>
                  <a href="/tags/microservice.html">microservice (12)</a>
                </li>
                <li>
                  <a href="/tags/modeling.html">modeling (1)</a>
                </li>
                <li>
                  <a href="/tags/personaldata.html">personalData (2)</a>
                </li>
                <li>
                  <a href="/tags/quicktips.html">quicktips (12)</a>
                </li>
                <li>
                  <a href="/tags/shift.html">shift (4)</a>
                </li>
                <li>
                  <a href="/tags/smallhints.html">smallhints (13)</a>
                </li>
                <li>
                  <a href="/tags/startup.html">startup (9)</a>
                </li>
              </ul>
            </li>
            <li class="dropdown">
              <a aria-expanded="false" class="dropdown-toggle" data-toggle="dropdown" href="#" role="button">By Year <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li>
                  <a href="/2016.html">2016 (9)</a>
                </li>
                <li>
                  <a href="/2015.html">2015 (35)</a>
                </li>
                <li>
                  <a href="/2014.html">2014 (10)</a>
                </li>
              </ul>
            </li>
            <ul class="list-unstyled list-inline nav navbar-nav navbar-right"></ul>
            <li><a href="https://twitter.com/talfco">
                        <i class="fa fa-lg fa-inverse fa-twitter-square"></i></a>
            </li>
            <li><a href="https://plus.google.com/u/1/b/102868953630532463137/+CloudburoCh/posts">
                        <i class="fa fa-lg fa-inverse fa-google-plus-square"></i></a>
            </li>
            <li><a href="https://www.linkedin.com/in/felixk">
                        <i class="fa fa-lg fa-inverse fa-linkedin-square"></i></a>
            </li>
            <li><a href="https://github.com/talfco">
                        <i class="fa fa-lg fa-inverse fa-github-square"></i></a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-lg-9 col-md-9">
          <h1>
            Meteor Small Hints #5: Server Code Fragments executed twice on Startup
          </h1>
          <small class="label label-default">smallhints</small>
          <small class="label label-default">meteor</small>
          <hr />
          <p>
            <span class="glyphicon glyphicon-time"></span> Posted on Jul 18
          </p>
          <hr /><div class="row">
  <div class="article"><p><span/>      <div>
    Recently I got confused with my Meteor application, by having the server code executed twice at startup. So the code was initialising my application twice, as well as duplicated for example my Slack Sysadmin Bot running as part of the instance.
  </div>
  <div>
   <br>
  </div>
  <div>
    I was first thinking that it has something to do with my IntelliJ Webstorm IDE running in debug mode, but also the local test-, as well the my Modulus remote environment was showing the same symptom.
  </div>
  <div>
   <br>
  </div>
  <div>
    After some hours of debugging I luckily found the following
   <a href="https://github.com/Differential/meteor-workers/issues/9">Github issue entry</a> which showed me the right direction.
  </div>
  <div>
   <br>
  </div>
  <div>
    As part of my application I introduced
   <a href="https://github.com/Differential/meteor-workers">Differential meteor-workers</a>, which allows to spawn headless worker meteor processes to work on async jobs. For example, passing a message to my Slack SysAdmin Bot is done via Job.
  </div>
  <div>
   <br>
  </div>
  <div></p>
<pre class="highlight coffeescript"><code>
  <span class="k">class</span> <span class="vi">@</span><span class="na">SlackSysAdminBotJob</span> <span class="k">extends</span> <span class="nx">Job</span> 
    <span class="na">handleJob</span><span class="o">:</span> <span class="p">()</span><span class="o">-&gt;</span> 
      <span class="k">if</span> <span class="vi">@</span><span class="na">params</span><span class="p">.</span><span class="na">action</span> <span class="o">==</span> <span class="s">"sendMessage"</span> 
        <span class="vi">@</span><span class="na">params</span><span class="p">.</span><span class="na">bot</span><span class="p">.</span><span class="na">postTo</span> <span class="vi">@</span><span class="na">params</span><span class="p">.</span><span class="na">name</span><span class="p">,</span> <span class="vi">@</span><span class="na">params</span><span class="p">.</span><span class="na">text</span> 

</code></pre>

<div>
   <br>
  </div>

<p><div>
    Such a async Job can be easily triggered, like shown here (which will hand the work over to a worker process.
  </div>
  <div>
   <br>
  </div>
  <div></p>
<pre class="highlight coffeescript"><code>
    <span class="nx">Job</span><span class="p">.</span><span class="na">push</span> <span class="k">new</span> <span class="nx">SlackSysAdminBotJob</span> 
          <span class="na">action</span><span class="o">:</span> <span class="s">"sendMessage"</span> 
          <span class="na">slackBot</span><span class="o">:</span> <span class="nx">myBot</span> 
          <span class="na">text</span><span class="o">:</span><span class="nx">txt</span> 
          <span class="na">name</span><span class="o">:</span> <span class="nx">channel</span> 
        <span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">job</span><span class="p">)</span> <span class="o">-&gt;</span> 
           <span class="c1"># Check it 
</span>
</code></pre>

<div>
   <br>
  </div>

<p><div>
    Now introducing the Differential async worker resulted in the problem, that not only the master process, BUT also the worker process will be initialised with each Server startup code fragment. Which is not what we want.
  </div>
  <div>
   <br>
  </div>
  <div>
    So I had to extend each server Meter.startup code fragment by introducing an
   <i>isClusterMaster</i> check
  </div>
  <div>
   <br>
  </div>
  <div>
   <div></p>
<pre class="highlight coffeescript"><code>
  <span class="nx">exports</span><span class="p">.</span><span class="na">Plattform</span> <span class="o">=</span> 
      <span class="na">isClusterMaster</span><span class="o">:</span> <span class="p">()</span> <span class="o">-&gt;</span> 
        <span class="k">return</span> <span class="nx">Meteor</span><span class="p">.</span><span class="na">isServer</span> <span class="o">&amp;&amp;</span> <span class="nx">Npm</span><span class="p">.</span><span class="na">require</span><span class="p">(</span><span class="s">'cluster'</span><span class="p">).</span><span class="na">isMaster</span> 


</code></pre>

<div>
   <br>
  </div>

<p><div>
    As for example:
  </div>
  <div>
   <br>
  </div>
  <div></p>
<pre class="highlight coffeescript"><code>
  <span class="nx">Meteor</span><span class="p">.</span><span class="na">startup</span> <span class="p">()</span> <span class="o">-&gt;</span> 
    <span class="k">if</span> <span class="nx">Plattform</span><span class="p">.</span><span class="na">isClusterMaster</span><span class="p">()</span> 
      <span class="c1"># The startup code 
</span>
</code></pre>

<p></div>
  <div>
   <br>
  </div>
  <div>
    Now the startup initialization will be only executed on the master in the cluster and not for each worker process.
  </div>
  <div>
   <br>
  </div></p>

  </div>
</div>
          <hr />
          <div id="disqus_thread"></div>
          <script type="text/javascript">
          //<![CDATA[
                            var disqus_shortname = 'dev1cloudburo';
                    
              (function() {
                  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
          //]]>
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          <script type="text/javascript">
          //<![CDATA[
              var disqus_shortname = 'dev1cloudburo';
              (function () {
                  var s = document.createElement('script'); s.async = true;
                  s.type = 'text/javascript';
                  s.src = '//' + disqus_shortname + '.disqus.com/count.js';
                  (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
              }());
          //]]>
          </script>
          
          <aside>
            <h3>
              Recent Articles
            </h3>
            <ol>
              <li>
                <a href="/2016/07/18/meteor-small-hints-5-server-code-fragments-executed-twice-on-startup.html">Meteor Small Hints #5: Server Code Fragments executed twice on Startup</a> <span>Jul 18</span> 
              </li>
              <li>
                <a href="/2016/06/21/a-terminology-guide-to-daos-dacs-das-and-more.html">A Terminology Guide to DAOs, DACs, DAs and More</a> <span>Jun 21</span> 
              </li>
              <li>
                <a href="/2016/06/09/a-categorisation-of-bots-used-for-conversational-commerce.html">A categorisation of bots used for conversational commerce</a> <span>Jun  9</span> 
              </li>
              <li>
                <a href="/2016/05/23/meteor-small-hints-4-reading-this-params-values-in-the-iron-router-data-context.html">Meteor Small Hints #4: Reading this.params values in the iron-router Data Context</a> <span>May 23</span> 
              </li>
              <li>
                <a href="/2016/05/13/how-we-built-an-ecommerce-business-from-scratch-and-generated-922-16-in-revenue-.html">How We Built an Ecommerce Business from Scratch and Generated $922.16 in Revenue in 3 Days</a> <span>May 13</span> 
              </li>
              <li>
                <a href="/2016/05/12/the-anatomy-of-a-eb-based-microservice-github-docker-integration.html">The Anatomy of a EB based Microservice - Github Docker Integration</a> <span>May 12</span> 
              </li>
              <li>
                <a href="/2016/04/24/meteor-small-hints-3-passing-query-parameters-to-signup-route.html">Meteor Small Hints #3: Passing Query Parameters to Signup Route</a> <span>Apr 24</span> 
              </li>
              <li>
                <a href="/2016/04/21/meteor-small-hints-2-calling-local-methods-in-a-template.html">Meteor Small Hints #2: Calling local methods in a Template</a> <span>Apr 21</span> 
              </li>
              <li>
                <a href="/2016/03/04/rodrigue-schaefer-from-monolith-to-microservices-at-zalando.html">Rodrigue Schaefer : From monolith to microservices at Zalando</a> <span>Mar  4</span> 
              </li>
              <li>
                <a href="/2015/12/20/the-anatomy-of-a-eb-based-microservice-aws-security-configuration.html">The Anatomy of a EB based Microservice - AWS Security Configuration</a> <span>Dec 20</span> 
              </li>
            </ol>
          </aside>
          <hr>
            <p class="text-center">
              ©2016 <a href="/">dev@cloudburo</a> <br /><span class="small">Powered by<a href="https://cloudburo.net/docs/products.html"> Cloudburo Curation Engine</a></span>
            </p>
          </hr>
        </div>
        <div class="col-lg-3 col-md-3">
          <div class="well">
            <h4>
              Categories
            </h4>
            <ul class="list-unstyled">
              <li>
                <a href="/tags/api.html">api</a> (2)
              </li>
              <li>
                <a href="/tags/architecture.html">architecture</a> (10)
              </li>
              <li>
                <a href="/tags/aws.html">aws</a> (10)
              </li>
              <li>
                <a href="/tags/banking.html">banking</a> (1)
              </li>
              <li>
                <a href="/tags/blockchain.html">blockchain</a> (1)
              </li>
              <li>
                <a href="/tags/bootstrap.html">bootstrap</a> (1)
              </li>
              <li>
                <a href="/tags/bots.html">bots</a> (1)
              </li>
              <li>
                <a href="/tags/deutsch.html">deutsch</a> (1)
              </li>
              <li>
                <a href="/tags/docker.html">docker</a> (9)
              </li>
              <li>
                <a href="/tags/futurework.html">futureWork</a> (5)
              </li>
              <li>
                <a href="/tags/googleapps.html">googleapps</a> (1)
              </li>
              <li>
                <a href="/tags/gradle.html">gradle</a> (2)
              </li>
              <li>
                <a href="/tags/inspiration.html">inspiration</a> (2)
              </li>
              <li>
                <a href="/tags/legal.html">legal</a> (1)
              </li>
              <li>
                <a href="/tags/meteor.html">meteor</a> (5)
              </li>
              <li>
                <a href="/tags/microservice.html">microservice</a> (12)
              </li>
              <li>
                <a href="/tags/modeling.html">modeling</a> (1)
              </li>
              <li>
                <a href="/tags/personaldata.html">personalData</a> (2)
              </li>
              <li>
                <a href="/tags/quicktips.html">quicktips</a> (12)
              </li>
              <li>
                <a href="/tags/shift.html">shift</a> (4)
              </li>
              <li>
                <a href="/tags/smallhints.html">smallhints</a> (13)
              </li>
              <li>
                <a href="/tags/startup.html">startup</a> (9)
              </li>
            </ul>
          </div>
          <div class="well">
            <h4>
              By year
            </h4>
            <ol>
              <li>
                <a href="/2016.html">2016</a> (9)
              </li>
              <li>
                <a href="/2015.html">2015</a> (35)
              </li>
              <li>
                <a href="/2014.html">2014</a> (10)
              </li>
            </ol>
          </div>
        </div>
      </div>
    </div>
    <script src="../../../js/all.js" type="text/javascript"></script>
  </body>
</html>